<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="slider.css">
    <script
    src="https://code.jquery.com/jquery-3.7.1.js"
    integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
    crossorigin="anonymous"></script>
    <title>My First Webpage</title>
    <link rel="icon" type="image/x-icon" href="/radio/favicon.ico">
    <script src="https://kit.fontawesome.com/ad713b1678.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="main">
        <div class="radio">
            <div class="np-header"><strong>NOW PLAYING</strong></div>
            <div class="song-name">Song Name</div>
            <div class="song-artist">Song Artist</div>
            <div class="game-list">Game List</div>
            
            <audio id="player" preload="none" autoplay="autoplay" src="https://radio.foxgirl.top/listen/fangame_radio/live"></audio>
            <div> 
                <button id="play-button" onclick="togglePlaying()"></button> 
                <input type="range" id="volume" name="volume" min="0" max="1" step="0.01" value="0.3" />
            </div>
        </div>
        <!-- requests are currently disabled -->
        <!-- <iframe src="https://radio.foxgirl.top/public/fangame_radio/embed-requests?theme=dark" frameborder="0" allowtransparency="true" style="width: 60%; min-height: 900px; max-width: 700px; border: 0;"></iframe> -->
    </div>
    <script>
        var player = document.getElementById('player');
        var isPlaying = true;
        togglePlaying();
        player.onplay = function() { isPlaying = true; $("#play-button").html("<i class=\"fa-2x fa-solid fa-pause\"></i>"); }
        function togglePlaying() {
            if (isPlaying == true) {
                player.pause();
                isPlaying = false;
                $("#play-button").html("<i class=\"fa-2x fa-solid fa-play\"></i>");
            } else {
                if (player.buffered.length != 0) {
                    player.currentTime = player.buffered.end(0);
                }
                player.play();
            }
        }
        var volSlider = document.getElementById('volume');
        volSlider.addEventListener("change", function(e) {
            player.volume = e.currentTarget.value;
        });
        
        let socket = new WebSocket("wss://radio.foxgirl.top/api/live/nowplaying/websocket");
        
        socket.onopen = function(e) {
            socket.send(JSON.stringify({
                "subs": {
                    "station:fangame_radio": {"recover": true}
                }
            }));
        };
        
        let nowplaying = {};
        let currentTime = 0;
        
        // Handle a now-playing event from a station. Update your now-playing data accordingly.
        function handleSseData(ssePayload, useTime = true) {
            const jsonData = ssePayload.data;
            
            if (useTime && 'current_time' in jsonData) {
                currentTime = jsonData.current_time;
            }
            
            nowplaying = jsonData.np;
            $(".song-name").html(nowplaying.now_playing.song.title);
            $(".song-artist").html("by " + nowplaying.now_playing.song.artist);
            $(".game-list").html("Used in: " + nowplaying.now_playing.song.custom_fields.c_games);
        }
        
        socket.onmessage = function(e) {
            const jsonData = JSON.parse(e.data);
            
            if ('connect' in jsonData) {
                const connectData = jsonData.connect;
                
                if ('data' in connectData) {
                    // Legacy SSE data
                    connectData.data.forEach(
                    (initialRow) => handleSseData(initialRow)
                    );
                } else {
                    // New Centrifugo time format
                    if ('time' in connectData) {
                        currentTime = Math.floor(connectData.time / 1000);
                    }
                    
                    // New Centrifugo cached NowPlaying initial push.
                    for (const subName in connectData.subs) {
                        const sub = connectData.subs[subName];
                        if ('publications' in sub && sub.publications.length > 0) {
                            sub.publications.forEach((initialRow) => handleSseData(initialRow, false));
                        }
                    }
                }
            } else if ('pub' in jsonData) {
                handleSseData(jsonData.pub);
            }
        };
        // var np;
        // var npTimeout;
        
        // function npLoad() {
        //     $.ajax({
        //         cache: false,
        //         url: "https://radio.foxgirl.top/api/nowplaying/fangame_radio",
        //         success: function(result) {
        //             np = result;
        //             npTimeout = setTimeout(npLoad, 15000);
        
        //             $(".song-name").html(np.now_playing.song.title);
        //             $(".song-artist").html("by " + np.now_playing.song.artist);
        //             $(".game-list").html("Used in: " + np.now_playing.song.custom_fields.c_games);
        
        //         }
        //     }).fail(function() { npTimeout = setTimeout(npLoad, 30000); });
        // }
        
        // $( document ).ready(function() {
        //     npLoad();
        // });
    </script>
</body>
</html>